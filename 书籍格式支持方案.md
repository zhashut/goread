# GoRead å¤šä¹¦ç±æ ¼å¼æ”¯æŒæ–¹æ¡ˆ

> ç‰ˆæœ¬ï¼š1.0
> æ—¥æœŸï¼š2024-12-08
> ä½œè€…ï¼šClaude & Gemini-3-Pro-Preview åä½œæ–¹æ¡ˆ

---

## ç›®å½•

1. [èƒŒæ™¯ä¸ç›®æ ‡](#1-èƒŒæ™¯ä¸ç›®æ ‡)
2. [æ ¼å¼æ”¯æŒæ–¹æ¡ˆ](#2-æ ¼å¼æ”¯æŒæ–¹æ¡ˆ)
3. [æ¶æ„è®¾è®¡](#3-æ¶æ„è®¾è®¡)
4. [ç°æœ‰ä»£ç åˆ†æ](#4-ç°æœ‰ä»£ç åˆ†æ)
5. [é‡æ„è®¡åˆ’](#5-é‡æ„è®¡åˆ’)
6. [å¼€å‘è®¡åˆ’ä¸ä¼˜å…ˆçº§](#6-å¼€å‘è®¡åˆ’ä¸ä¼˜å…ˆçº§)
7. [æŠ€æœ¯ç»†èŠ‚](#7-æŠ€æœ¯ç»†èŠ‚)

---

## 1. èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 å½“å‰çŠ¶æ€

GoRead ç›®å‰ä»…æ”¯æŒ PDF æ ¼å¼ï¼Œé‡‡ç”¨ Tauri v2 (Rust åç«¯ + React å‰ç«¯) æ¶æ„ï¼š

- **åç«¯**: ä½¿ç”¨ `pdfium-render` è¿›è¡Œ PDF æ¸²æŸ“ï¼Œå…·æœ‰å®Œå–„çš„ç¼“å­˜ã€é¢„åŠ è½½ã€å¹¶è¡Œæ¸²æŸ“ç­‰ä¼˜åŒ–
- **å‰ç«¯**: `Reader.tsx` ç»„ä»¶è´Ÿè´£é˜…è¯»ç•Œé¢ï¼Œä½†ç›´æ¥è€¦åˆäº† PDF ç›¸å…³çš„ Tauri å‘½ä»¤è°ƒç”¨

### 1.2 ç›®æ ‡

1. æ”¯æŒæ›´å¤šä¹¦ç±æ ¼å¼ï¼š**EPUBã€Markdownã€MOBIã€AZW3ã€FB2ã€HTML**
2. è®¾è®¡ç»Ÿä¸€çš„æ¥å£æŠ½è±¡ï¼Œæ–¹ä¾¿åç»­æ‰©å±•æ–°æ ¼å¼
3. å¤ç”¨ç°æœ‰çš„é˜…è¯»é€»è¾‘ï¼ˆç¿»é¡µã€ä¹¦ç­¾ã€ç›®å½•ã€è¿›åº¦ç­‰ï¼‰
4. ä¿æŒç°æœ‰ PDF é˜…è¯»ä½“éªŒä¸å˜

---

## 2. æ ¼å¼æ”¯æŒæ–¹æ¡ˆ

### 2.1 æ–¹æ¡ˆæ€»è§ˆ

| æ ¼å¼ | åç«¯ (Rust) | å‰ç«¯ (React) | æ¸²æŸ“ç­–ç•¥ | ä¼˜å…ˆçº§ |
|------|-------------|--------------|----------|--------|
| **PDF** | `pdfium-render` (ç°æœ‰) | Canvas æ¸²æŸ“ | å›¾ç‰‡ | âœ… å·²å®Œæˆ |
| **EPUB** | `epub-rs` (å…ƒæ•°æ®æå–) | `epub.js` | HTML/CSS | ğŸ”´ P0 |
| **MD** | æ–‡ä»¶è¯»å– | `md-editor-rt` | HTML é¢„è§ˆ | ğŸ”´ P0 |
| **MOBI** | `mobi-rs` (å…ƒæ•°æ®) | `foliate-js` | HTML | ğŸŸ¡ P1 |
| **AZW3** | äºŒè¿›åˆ¶æµä¼ é€’ | `foliate-js` | HTML | ğŸŸ¡ P1 |
| **FB2** | `quick-xml` (è§£æ) | `foliate-js` | HTML | ğŸŸ¢ P2 |
| **HTML** | - | åŸç”Ÿ DOM/`iframe` | HTML | ğŸŸ¢ P2 |

### 2.2 Gemini æ–¹æ¡ˆè¯„å®¡ä¸æ”¹è¿›

#### âœ… ä¿ç•™çš„å»ºè®®

1. **EPUB**: ä½¿ç”¨ `epub.js` æ˜¯æ­£ç¡®é€‰æ‹©ï¼Œä½†å»ºè®®ç›´æ¥ä½¿ç”¨ `epub.js` è€Œé `react-reader`ï¼Œå› ä¸ºåè€…æ›´æ–°è¾ƒæ…¢ä¸”å®šåˆ¶æ€§å·®
3. **Rust è´Ÿè´£è§£æï¼Œå‰ç«¯è´Ÿè´£æ¸²æŸ“**: è¿™æ˜¯æ­£ç¡®çš„æ¶æ„æ€è·¯

#### âš ï¸ éœ€è¦è°ƒæ•´çš„å»ºè®®

1. **foliate-js é›†æˆ**:
   - é—®é¢˜ï¼š`foliate-js` ä¸æ˜¯ npm åŒ…ï¼Œéœ€è¦æ‰‹åŠ¨ç®¡ç†
   - æ”¹è¿›ï¼šå°† `foliate-js` æºç æ”¾å…¥ `public/lib/foliate-js/` ç›®å½•ï¼Œé€šè¿‡åŠ¨æ€ import ä½¿ç”¨
   - æˆ–è€…è€ƒè™‘ä½¿ç”¨ `@nickolaj/foliate-js` npm åˆ†æ”¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

2. **MOBI/AZW3 å¤„ç†**:
   - é—®é¢˜ï¼šRust ç”Ÿæ€å¯¹è¿™äº›æ ¼å¼æ”¯æŒæœ‰é™
   - æ”¹è¿›ï¼šä¼˜å…ˆåœ¨å‰ç«¯ä½¿ç”¨ `foliate-js` å¤„ç†ï¼ŒRust ç«¯ä»…è´Ÿè´£æ–‡ä»¶è¯»å–å’Œå…ƒæ•°æ®ç¼“å­˜

3. **ç¼ºå¤±çš„æ¥å£æŠ½è±¡**:
   - Gemini æ–¹æ¡ˆæœªæåŠå¦‚ä½•è®¾è®¡ç»Ÿä¸€æ¥å£
   - æœ¬æ–¹æ¡ˆå°†å®šä¹‰å®Œæ•´çš„æ¥å£ä½“ç³»

4. **æ–°å¢ Markdown æ”¯æŒ**:
   - ä½¿ç”¨ `md-editor-rt`ï¼ˆ`md-editor-v3` çš„ React ç‰ˆæœ¬ï¼‰è¿›è¡Œ Markdown é¢„è§ˆ
   - æ”¯æŒ GitHub é£æ ¼ Markdownã€ä»£ç é«˜äº®ã€Mermaid å›¾è¡¨ã€KaTeX æ•°å­¦å…¬å¼
   - çº¯å‰ç«¯æ¸²æŸ“ï¼Œåç«¯ä»…è´Ÿè´£æ–‡ä»¶è¯»å–å’Œç¼–ç æ£€æµ‹

---

## 3. æ¶æ„è®¾è®¡

### 3.1 æ ¸å¿ƒæ¥å£å®šä¹‰

#### 3.1.1 åç«¯ (Rust) æ¥å£

```rust
// src-tauri/src/formats/mod.rs

/// ä¹¦ç±æ ¼å¼å¼•æ“çš„ç»Ÿä¸€ trait
pub trait BookEngine: Send + Sync {
    /// è·å–ä¹¦ç±å…ƒæ•°æ®
    fn get_metadata(&self) -> Result<BookMetadata, BookError>;
    
    /// è·å–ç›®å½•ç»“æ„
    fn get_toc(&self) -> Result<Vec<TocItem>, BookError>;
    
    /// è·å–æ€»é¡µæ•°/ç« èŠ‚æ•°
    fn get_page_count(&self) -> u32;
    
    /// æ¸²æŸ“æŒ‡å®šé¡µé¢ï¼ˆå¯¹äº PDF è¿”å›å›¾ç‰‡ï¼Œå¯¹äº EPUB/HTML è¿”å›å†…å®¹æ•°æ®ï¼‰
    fn render_page(&self, page: u32, options: RenderOptions) -> Result<PageContent, BookError>;
    
    /// æœç´¢æ–‡æœ¬
    fn search_text(&self, query: &str, case_sensitive: bool) -> Result<Vec<SearchResult>, BookError>;
    
    /// æå–æŒ‡å®šé¡µé¢çš„æ–‡æœ¬
    fn extract_text(&self, page: u32) -> Result<String, BookError>;
    
    /// å…³é—­æ–‡æ¡£ï¼Œé‡Šæ”¾èµ„æº
    fn close(&mut self);
}

/// ä¹¦ç±å…ƒæ•°æ®
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct BookMetadata {
    pub title: Option<String>,
    pub author: Option<String>,
    pub publisher: Option<String>,
    pub language: Option<String>,
    pub description: Option<String>,
    pub cover_image: Option<Vec<u8>>,
    pub page_count: u32,
    pub format: BookFormat,
}

/// æ”¯æŒçš„ä¹¦ç±æ ¼å¼
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum BookFormat {
    Pdf,
    Epub,
    Markdown,
    Mobi,
    Azw3,
    Fb2,
    Html,
}

/// é¡µé¢å†…å®¹ï¼ˆä¸åŒæ ¼å¼è¿”å›ä¸åŒç±»å‹ï¼‰
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum PageContent {
    /// PDF æ¸²æŸ“ç»“æœï¼šå›¾ç‰‡æ•°æ®
    Image {
        data: Vec<u8>,
        width: u32,
        height: u32,
        format: ImageFormat,
    },
    /// EPUB/FB2/MOBI ç« èŠ‚ï¼šHTML å†…å®¹
    Html {
        content: String,
        resources: Vec<Resource>,
    },
    /// Markdown å†…å®¹ï¼šåŸå§‹ Markdown æ–‡æœ¬
    Markdown {
        content: String,
        encoding: String,
    },
}
```

#### 3.1.2 å‰ç«¯ (TypeScript) æ¥å£

```typescript
// src/services/formats/types.ts

/** ä¹¦ç±æ¸²æŸ“å¼•æ“æ¥å£ */
export interface IBookRenderer {
  /** æ ¼å¼æ ‡è¯† */
  format: BookFormat;
  
  /** åŠ è½½æ–‡æ¡£ */
  loadDocument(filePath: string): Promise<BookInfo>;
  
  /** è·å–ç›®å½• */
  getToc(): Promise<TocItem[]>;
  
  /** æ¸²æŸ“é¡µé¢åˆ°å®¹å™¨ */
  renderPage(page: number, container: HTMLElement, options?: RenderOptions): Promise<void>;
  
  /** è·å–å½“å‰å¯è§†é¡µç ï¼ˆç”¨äºè¿ç»­æ»šåŠ¨æ¨¡å¼ï¼‰ */
  getCurrentPage(): number;
  
  /** è·³è½¬åˆ°æŒ‡å®šé¡µé¢ */
  goToPage(page: number): Promise<void>;
  
  /** æœç´¢æ–‡æœ¬ */
  searchText(query: string): Promise<SearchResult[]>;
  
  /** å…³é—­æ–‡æ¡£ */
  close(): Promise<void>;
}

/** ä¹¦ç±æ ¼å¼æšä¸¾ */
export type BookFormat = 'pdf' | 'epub' | 'markdown' | 'mobi' | 'azw3' | 'fb2' | 'html';

/** ä¹¦ç±ä¿¡æ¯ */
export interface BookInfo {
  title?: string;
  author?: string;
  pageCount: number;
  format: BookFormat;
  coverImage?: string;
}

/** æ¸²æŸ“é€‰é¡¹ */
export interface RenderOptions {
  quality?: 'thumbnail' | 'standard' | 'high' | 'best';
  width?: number;
  height?: number;
  theme?: 'light' | 'dark' | 'sepia';
  fontSize?: number;
}
```

### 3.2 ç›®å½•ç»“æ„è®¾è®¡

```
goread/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ formats/                    # æ–°å¢ï¼šæ ¼å¼æœåŠ¡å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts                # å·¥å‚æ–¹æ³• & å¯¼å‡º
â”‚   â”‚   â”‚   â”œâ”€â”€ types.ts                # æ¥å£å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ pdf/                    # PDF æ¸²æŸ“å™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ PdfRenderer.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ epub/                   # EPUB æ¸²æŸ“å™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ EpubRenderer.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ markdown/               # Markdown æ¸²æŸ“å™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ MarkdownRenderer.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ html/                   # HTML æ¸²æŸ“å™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ HtmlRenderer.ts
â”‚   â”‚   â”‚   â””â”€â”€ foliate/                # MOBI/AZW3/FB2 æ¸²æŸ“å™¨
â”‚   â”‚   â”‚       â””â”€â”€ FoliateRenderer.ts
â”‚   â”‚   â””â”€â”€ index.ts                    # ç°æœ‰æœåŠ¡
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ Reader.tsx                  # é‡æ„ï¼šä½¿ç”¨æ¸²æŸ“å™¨æ¥å£
â”‚   â”‚   â””â”€â”€ reader/                     # ç°æœ‰å­ç»„ä»¶
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ ...
â”œâ”€â”€ public/
â”‚   â””â”€â”€ lib/
â”‚       â””â”€â”€ foliate-js/                 # æ–°å¢ï¼šfoliate-js æºç 
â”œâ”€â”€ src-tauri/
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ formats/                    # æ–°å¢ï¼šæ ¼å¼å¼•æ“å±‚
â”‚       â”‚   â”œâ”€â”€ mod.rs                  # trait å®šä¹‰ & å¯¼å‡º
â”‚       â”‚   â”œâ”€â”€ pdf/                    # ç°æœ‰ PDF ä»£ç ç§»åŠ¨è‡³æ­¤
â”‚       â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚       â”‚   â”‚   â”œâ”€â”€ engine.rs
â”‚       â”‚   â”‚   â”œâ”€â”€ renderer.rs
â”‚       â”‚   â”‚   â”œâ”€â”€ cache.rs
â”‚       â”‚   â”‚   â””â”€â”€ types.rs
â”‚       â”‚   â”œâ”€â”€ epub/                   # EPUB å¼•æ“
â”‚       â”‚   â”‚   â””â”€â”€ mod.rs
â”‚       â”‚   â”œâ”€â”€ markdown/               # Markdown å¼•æ“ï¼ˆæ–‡ä»¶è¯»å–ï¼‰
â”‚       â”‚   â”‚   â””â”€â”€ mod.rs
â”‚       â”‚   â””â”€â”€ common/                 # å…±ç”¨å·¥å…·
â”‚       â”‚       â””â”€â”€ mod.rs
â”‚       â”œâ”€â”€ format_commands.rs          # ç»Ÿä¸€å‘½ä»¤å…¥å£
â”‚       â”œâ”€â”€ pdf_commands.rs             # ä¿ç•™å…¼å®¹ï¼ˆå¯é€æ­¥è¿ç§»ï¼‰
â”‚       â””â”€â”€ lib.rs
â””â”€â”€ ...
```

---

## 4. ç°æœ‰ä»£ç åˆ†æ

### 4.1 å‰ç«¯é˜…è¯»é€»è¾‘åˆ†æ

å½“å‰ `Reader.tsx` ä¸­å¯å¤ç”¨çš„é€»è¾‘ï¼š

| åŠŸèƒ½ | å¯å¤ç”¨æ€§ | è¯´æ˜ |
|------|----------|------|
| UI çŠ¶æ€ç®¡ç† | âœ… å®Œå…¨å¤ç”¨ | `uiVisible`, `isSeeking`, `seekPage` ç­‰ |
| é˜…è¯»æ¨¡å¼åˆ‡æ¢ | âœ… å®Œå…¨å¤ç”¨ | æ¨ªå‘/çºµå‘æ¨¡å¼ |
| ä¹¦ç­¾åŠŸèƒ½ | âœ… å®Œå…¨å¤ç”¨ | é€šè¿‡ `bookmarkService` |
| ç›®å½•æ˜¾ç¤º | âš ï¸ éƒ¨åˆ†å¤ç”¨ | éœ€è¦é€‚é…ä¸åŒæ ¼å¼çš„ç›®å½•ç»“æ„ |
| ç¿»é¡µé€»è¾‘ | âœ… å®Œå…¨å¤ç”¨ | æ‰‹åŠ¿ã€éŸ³é‡é”®ç­‰ |
| è¿›åº¦ä¿å­˜ | âœ… å®Œå…¨å¤ç”¨ | é€šè¿‡ `bookService.updateBookProgress` |
| è‡ªåŠ¨æ»šåŠ¨ | âœ… å®Œå…¨å¤ç”¨ | ä»…é€‚ç”¨äºçºµå‘æ¨¡å¼ |
| é¡µé¢æ¸²æŸ“ | âŒ éœ€é‡æ„ | ç›®å‰ç›´æ¥è°ƒç”¨ `pdf_*` å‘½ä»¤ |
| ç¼“å­˜ç®¡ç† | âš ï¸ éœ€é€‚é… | PDF ä½¿ç”¨ Canvasï¼ŒEPUB ä½¿ç”¨ DOM |

### 4.2 åç«¯é€»è¾‘åˆ†æ

å½“å‰ `pdf/` æ¨¡å—çš„ä¼˜åŒ–é€»è¾‘ï¼š

| ç»„ä»¶ | å¯å¤ç”¨æ€§ | è¯´æ˜ |
|------|----------|------|
| `CacheManager` | âš ï¸ éœ€æ³›åŒ– | å¯æŠ½è±¡ä¸ºé€šç”¨ç¼“å­˜ |
| `PreloadPredictor` | âœ… å¯å¤ç”¨ | é¢„åŠ è½½é¢„æµ‹ç®—æ³• |
| `PerformanceMonitor` | âœ… å¯å¤ç”¨ | æ€§èƒ½ç›‘æ§ |
| `PdfEngine` | âŒ PDF ä¸“ç”¨ | ä½†æ¨¡å¼å¯å€Ÿé‰´ |

### 4.3 ç°æœ‰é—®é¢˜

1. **å‰ç«¯**: `Reader.tsx` ç›´æ¥è°ƒç”¨ `invoke('pdf_render_page_to_file', ...)` ç­‰å‘½ä»¤ï¼Œæ²¡æœ‰æŠ½è±¡å±‚
2. **åç«¯**: PDF ä»£ç ä½äº `src-tauri/src/pdf/`ï¼Œå‘½ä»¤ä½äº `pdf_commands.rs`ï¼Œéœ€è¦é‡ç»„ç›®å½•ç»“æ„
3. **æ–‡ä»¶ç±»å‹**: `fileTypes.ts` ç¡¬ç¼–ç  `['.pdf']`

---

## 5. é‡æ„è®¡åˆ’

### 5.1 Phase 0: å‡†å¤‡å·¥ä½œï¼ˆä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼‰

#### Step 0.1: åˆ›å»ºç›®å½•ç»“æ„

```bash
# å‰ç«¯
mkdir -p src/services/formats/pdf
mkdir -p src/services/formats/epub
mkdir -p src/services/formats/html
mkdir -p src/services/formats/foliate
mkdir -p public/lib/foliate-js

# åç«¯
mkdir -p src-tauri/src/formats/pdf
mkdir -p src-tauri/src/formats/epub
mkdir -p src-tauri/src/formats/common
```

#### Step 0.2: å®šä¹‰æ¥å£æ–‡ä»¶

- åˆ›å»º `src/services/formats/types.ts`
- åˆ›å»º `src-tauri/src/formats/mod.rs`

### 5.2 Phase 1: PDF ä»£ç è¿ç§»ï¼ˆä¿æŒåŠŸèƒ½ä¸å˜ï¼‰

#### Step 1.1: åç«¯ PDF ä»£ç è¿ç§»

1. å°† `src-tauri/src/pdf/*` ç§»åŠ¨åˆ° `src-tauri/src/formats/pdf/`
2. æ›´æ–° `mod.rs` ä¸­çš„å¯¼å‡ºè·¯å¾„
3. ä¿æŒ `pdf_commands.rs` æš‚æ—¶ä¸å˜ï¼ˆä¿è¯å…¼å®¹ï¼‰

#### Step 1.2: å‰ç«¯ PDF æ¸²æŸ“å™¨å°è£…

1. åˆ›å»º `src/services/formats/pdf/PdfRenderer.ts`ï¼Œå®ç° `IBookRenderer` æ¥å£
2. å°† `Reader.tsx` ä¸­çš„ PDF ç›¸å…³è°ƒç”¨å°è£…åˆ° `PdfRenderer` ä¸­
3. `Reader.tsx` æ”¹ä¸ºè°ƒç”¨æ¸²æŸ“å™¨æ¥å£

### 5.3 Phase 2: å®ç° Markdown æ”¯æŒ

#### Step 2.1: å®‰è£…ä¾èµ–

```bash
npm install md-editor-rt
```

> **æ³¨æ„**: `md-editor-rt` æ˜¯ `md-editor-v3` çš„ React ç‰ˆæœ¬ï¼Œæä¾›ç›¸åŒçš„åŠŸèƒ½ä½†é€‚é… React ç”Ÿæ€ã€‚

#### Step 2.2: åç«¯ Markdown å¼•æ“

```rust
// src-tauri/src/formats/markdown/mod.rs
use chardetng::EncodingDetector;
use encoding_rs::Encoding;
use std::fs;
use std::path::Path;

pub struct MarkdownEngine {
    content: String,
    encoding: String,
    file_path: String,
}

impl MarkdownEngine {
    pub fn from_file(path: &str) -> Result<Self, BookError> {
        let bytes = fs::read(path)?;
        
        // ç¼–ç æ£€æµ‹
        let mut detector = EncodingDetector::new();
        detector.feed(&bytes, true);
        let encoding = detector.guess(None, true);
        let (decoded, _, _) = encoding.decode(&bytes);
        
        Ok(Self {
            content: decoded.into_owned(),
            encoding: encoding.name().to_string(),
            file_path: path.to_string(),
        })
    }
    
    /// è·å– Markdown å†…å®¹
    pub fn get_content(&self) -> &str {
        &self.content
    }
    
    /// è·å–æ–‡ä»¶åä½œä¸ºæ ‡é¢˜
    pub fn get_title(&self) -> Option<String> {
        Path::new(&self.file_path)
            .file_stem()
            .and_then(|s| s.to_str())
            .map(|s| s.to_string())
    }
    
    /// ä»å†…å®¹ä¸­æå–ç¬¬ä¸€ä¸ªæ ‡é¢˜ä½œä¸ºæ–‡æ¡£æ ‡é¢˜
    pub fn extract_title_from_content(&self) -> Option<String> {
        for line in self.content.lines() {
            let trimmed = line.trim();
            if trimmed.starts_with("# ") {
                return Some(trimmed[2..].trim().to_string());
            }
        }
        None
    }
}
```

#### Step 2.3: Tauri å‘½ä»¤

```rust
// src-tauri/src/format_commands.rs

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct MarkdownLoadResult {
    pub content: String,
    pub encoding: String,
    pub title: Option<String>,
}

#[tauri::command]
pub async fn markdown_load_document(file_path: String) -> Result<MarkdownLoadResult, String> {
    let engine = MarkdownEngine::from_file(&file_path)
        .map_err(|e| e.to_string())?;
    
    let title = engine.extract_title_from_content()
        .or_else(|| engine.get_title());
    
    Ok(MarkdownLoadResult {
        content: engine.get_content().to_string(),
        encoding: engine.encoding.clone(),
        title,
    })
}
```

#### Step 2.4: å‰ç«¯ Markdown æ¸²æŸ“å™¨

```typescript
// src/services/formats/markdown/MarkdownRenderer.ts
import { MdPreview } from 'md-editor-rt';
import 'md-editor-rt/lib/preview.css';
import { IBookRenderer, BookFormat, BookInfo, TocItem, SearchResult, RenderOptions } from '../types';

export class MarkdownRenderer implements IBookRenderer {
  format: BookFormat = 'markdown';
  private content: string = '';
  private title: string = '';
  private filePath: string = '';
  private previewId: string = 'md-preview-' + Date.now();
  
  async loadDocument(filePath: string): Promise<BookInfo> {
    const { invoke } = await import('@tauri-apps/api/core');
    const result = await invoke<{ content: string; encoding: string; title?: string }>(
      'markdown_load_document',
      { filePath }
    );
    
    this.content = result.content;
    this.title = result.title || this.extractFileName(filePath);
    this.filePath = filePath;
    
    return {
      title: this.title,
      pageCount: 1,  // Markdown ä¸ºå•é¡µæ»šåŠ¨æ¨¡å¼
      format: 'markdown',
    };
  }
  
  async getToc(): Promise<TocItem[]> {
    // ä» Markdown å†…å®¹ä¸­æå–æ ‡é¢˜ä½œä¸ºç›®å½•
    const toc: TocItem[] = [];
    const headingRegex = /^(#{1,6})\s+(.+)$/gm;
    let match;
    let index = 0;
    
    while ((match = headingRegex.exec(this.content)) !== null) {
      toc.push({
        title: match[2].trim(),
        level: match[1].length,
        page: 1,
        anchor: `heading-${index++}`,
      });
    }
    
    return toc;
  }
  
  async renderPage(
    page: number,
    container: HTMLElement,
    options?: RenderOptions
  ): Promise<void> {
    // æ¸…ç©ºå®¹å™¨
    container.innerHTML = '';
    
    // åˆ›å»º React æ ¹å…ƒç´ 
    const root = document.createElement('div');
    root.id = this.previewId;
    root.style.cssText = 'width: 100%; height: 100%; overflow-y: auto; padding: 16px;';
    container.appendChild(root);
    
    // åŠ¨æ€å¯¼å…¥ React å’Œ ReactDOM
    const React = await import('react');
    const ReactDOM = await import('react-dom/client');
    
    // æ ¹æ®ä¸»é¢˜è®¾ç½®é…ç½®
    const theme = options?.theme || 'light';
    const previewTheme = theme === 'dark' ? 'github' : 'default';
    const codeTheme = theme === 'dark' ? 'atom' : 'github';
    
    // æ¸²æŸ“ MdPreview ç»„ä»¶
    const reactRoot = ReactDOM.createRoot(root);
    reactRoot.render(
      React.createElement(MdPreview, {
        modelValue: this.content,
        previewTheme,
        codeTheme,
        style: {
          backgroundColor: 'transparent',
          fontSize: options?.fontSize ? `${options.fontSize}px` : undefined,
        },
      })
    );
    
    // ä¿å­˜å¼•ç”¨ä»¥ä¾¿æ¸…ç†
    (container as any).__reactRoot = reactRoot;
  }
  
  getCurrentPage(): number {
    return 1;
  }
  
  async goToPage(page: number): Promise<void> {
    // Markdown ä¸ºå•é¡µï¼Œæ— éœ€è·³è½¬
  }
  
  async searchText(query: string): Promise<SearchResult[]> {
    const results: SearchResult[] = [];
    const lines = this.content.split('\n');
    const lowerQuery = query.toLowerCase();
    
    lines.forEach((line, index) => {
      if (line.toLowerCase().includes(lowerQuery)) {
        results.push({
          page: 1,
          text: line.trim(),
          context: line,
          lineNumber: index + 1,
        });
      }
    });
    
    return results;
  }
  
  async close(): Promise<void> {
    // æ¸…ç† React æ ¹
    const container = document.getElementById(this.previewId)?.parentElement;
    if (container && (container as any).__reactRoot) {
      (container as any).__reactRoot.unmount();
      delete (container as any).__reactRoot;
    }
    this.content = '';
    this.title = '';
  }
  
  private extractFileName(filePath: string): string {
    const parts = filePath.replace(/\\/g, '/').split('/');
    const fileName = parts[parts.length - 1];
    return fileName.replace(/\.md$/i, '');
  }
}
```

#### Step 2.5: md-editor-rt ç‰¹æ€§é…ç½®

```typescript
// src/services/formats/markdown/config.ts

// å¯ç”¨å¯é€‰åŠŸèƒ½ï¼ˆæŒ‰éœ€å¯¼å…¥ï¼‰
import { config } from 'md-editor-rt';

// é…ç½® Mermaid å›¾è¡¨æ”¯æŒ
import mermaid from 'mermaid';
config({
  mermaidConfig: (base) => ({
    ...base,
    startOnLoad: false,
  }),
});

// é…ç½® KaTeX æ•°å­¦å…¬å¼æ”¯æŒ
import katex from 'katex';
import 'katex/dist/katex.min.css';
config({
  katexConfig: (base) => ({
    ...base,
    strict: false,
  }),
});

// é…ç½®ä»£ç é«˜äº®
import highlight from 'highlight.js';
import 'highlight.js/styles/github.css';
config({
  hljs: highlight,
});
```

### 5.4 Phase 3: å®ç° EPUB æ”¯æŒ

#### Step 3.1: å®‰è£…ä¾èµ–

```bash
npm install epub.js
```

#### Step 3.2: åç«¯ EPUB å…ƒæ•°æ®æå–

```toml
# Cargo.toml
[dependencies]
epub = "2.0"  # æˆ– epub-rs
```

```rust
// src-tauri/src/formats/epub/mod.rs
use epub::doc::EpubDoc;

pub fn extract_epub_metadata(path: &str) -> Result<BookMetadata, BookError> {
    let doc = EpubDoc::new(path)?;
    Ok(BookMetadata {
        title: doc.metadata.get("title").map(|v| v[0].clone()),
        author: doc.metadata.get("creator").map(|v| v[0].clone()),
        // ...
    })
}
```

#### Step 3.3: å‰ç«¯ EPUB æ¸²æŸ“å™¨

```typescript
// src/services/formats/epub/EpubRenderer.ts
import ePub, { Book, Rendition } from 'epubjs';

export class EpubRenderer implements IBookRenderer {
  format: BookFormat = 'epub';
  private book: Book | null = null;
  private rendition: Rendition | null = null;
  
  async loadDocument(filePath: string): Promise<BookInfo> {
    // é€šè¿‡ Tauri è¯»å–æ–‡ä»¶ä¸º ArrayBuffer
    const invoke = await getInvoke();
    const bytes = await invoke('read_file_bytes', { path: filePath });
    
    this.book = ePub(bytes);
    await this.book.ready;
    // ...
  }
  
  async renderPage(page: number, container: HTMLElement): Promise<void> {
    if (!this.rendition) {
      this.rendition = this.book!.renderTo(container, {
        width: '100%',
        height: '100%',
        flow: 'paginated',
      });
    }
    await this.rendition.display(/* chapter or cfi */);
  }
}
```

### 5.5 Phase 4: å®ç° MOBI/AZW3/FB2 æ”¯æŒ

#### Step 4.1: é›†æˆ foliate-js

1. ä¸‹è½½ `foliate-js` æºç åˆ° `public/lib/foliate-js/`
2. åˆ›å»ºé€‚é…å™¨ `FoliateRenderer.ts`

```typescript
// src/services/formats/foliate/FoliateRenderer.ts
export class FoliateRenderer implements IBookRenderer {
  format: BookFormat;
  private view: any = null;
  
  constructor(format: 'mobi' | 'azw3' | 'fb2') {
    this.format = format;
  }
  
  async loadDocument(filePath: string): Promise<BookInfo> {
    // åŠ¨æ€å¯¼å…¥ foliate-js
    const { makeBook } = await import('/lib/foliate-js/book.js');
    const invoke = await getInvoke();
    const bytes = await invoke('read_file_bytes', { path: filePath });
    
    const book = await makeBook(bytes, this.getFileType());
    // ...
  }
}
```

---

## 6. å¼€å‘è®¡åˆ’ä¸ä¼˜å…ˆçº§

### 6.1 é‡Œç¨‹ç¢‘

| é˜¶æ®µ | å†…å®¹ | é¢„ä¼°å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|------|----------|--------|
| Phase 0 | æ¥å£å®šä¹‰ & ç›®å½•ç»“æ„ | 2h | P0 |
| Phase 1 | PDF é‡æ„ï¼ˆå°è£…æ¥å£ï¼‰ | 4h | P0 |
| Phase 2 | Markdown æ”¯æŒ | 3h | P0 |
| Phase 3 | EPUB æ”¯æŒ | 6h | P0 |
| Phase 4 | MOBI/AZW3/FB2 æ”¯æŒ | 8h | P1 |
| Phase 5 | HTML æ”¯æŒ | 3h | P2 |
| Phase 6 | æµ‹è¯• & ä¼˜åŒ– | 4h | P2 |

### 6.2 è¯¦ç»†ä»»åŠ¡æ¸…å•

#### Phase 0: å‡†å¤‡å·¥ä½œ (2h) âœ… å·²å®Œæˆ

- [x] åˆ›å»º `src/services/formats/types.ts` æ¥å£å®šä¹‰
- [x] åˆ›å»º `src-tauri/src/formats/mod.rs` trait å®šä¹‰
- [x] æ›´æ–° `src/constants/fileTypes.ts` æ”¯æŒæ–°æ ¼å¼
- [x] åˆ›å»ºç›®å½•ç»“æ„

#### Phase 1: PDF é‡æ„ (4h) âœ… å·²å®Œæˆ

- [x] åˆ›å»º `src/services/formats/pdf/PdfRenderer.ts`
- [x] å°† `Reader.tsx` ä¸­ PDF æ¸²æŸ“é€»è¾‘è¿ç§»åˆ° `PdfRenderer`
- [x] åˆ›å»ºæ¸²æŸ“å™¨å·¥å‚ `src/services/formats/index.ts` å’Œ `registry.ts`
- [x] é‡æ„ `Reader.tsx` ä½¿ç”¨ `IBookRenderer` æ¥å£
- [x] åˆ›å»º `src/hooks/useBookRenderer.ts` æ¸²æŸ“å™¨ç®¡ç† Hook
- [x] æµ‹è¯• PDF é˜…è¯»åŠŸèƒ½æ­£å¸¸ï¼ˆéœ€æ‰‹åŠ¨æµ‹è¯•ï¼‰

#### Phase 2: Markdown æ”¯æŒ (3h) âœ… å·²å®Œæˆ

- [x] å®‰è£… `md-editor-rt` npm åŒ…
- [x] å®ç° `src-tauri/src/formats/markdown/mod.rs`ï¼ˆæ–‡ä»¶è¯»å– + ç¼–ç æ£€æµ‹ï¼‰
- [x] æ·»åŠ  `markdown_load_document` å‘½ä»¤
- [x] å®ç° `src/services/formats/markdown/MarkdownRenderer.ts`
- [x] é…ç½®ä¸»é¢˜æ”¯æŒï¼ˆlight/dark/sepiaï¼‰
- [x] æµ‹è¯• Markdown é˜…è¯»ï¼ˆåŒ…å«ä»£ç é«˜äº®ã€è¡¨æ ¼ã€å›¾è¡¨ç­‰ï¼‰- éœ€æ‰‹åŠ¨æµ‹è¯•

#### Phase 3: EPUB æ”¯æŒ (6h)

- [x] å®‰è£… `epub.js` npm åŒ…
- [x] æ·»åŠ  Rust ä¾èµ–: `epub` (å¯é€‰ï¼Œç”¨äºå…ƒæ•°æ®)
- [x] å®ç° `src/services/formats/epub/EpubRenderer.ts`
- [x] é€‚é…ç›®å½•ç»“æ„ï¼ˆEPUB ä½¿ç”¨ NCX/Navï¼‰
- [x] å¤„ç† EPUB å†…ç½®èµ„æºï¼ˆCSS/å›¾ç‰‡ï¼‰
- [x] æµ‹è¯• EPUB é˜…è¯»

#### Phase 4: MOBI/AZW3/FB2 æ”¯æŒ (8h)

- [ ] ä¸‹è½½å¹¶é›†æˆ `foliate-js`
- [ ] å®ç° `src/services/formats/foliate/FoliateRenderer.ts`
- [ ] å¤„ç†ä¸åŒæ ¼å¼çš„å·®å¼‚
- [ ] æµ‹è¯•å„æ ¼å¼é˜…è¯»

#### Phase 5: HTML æ”¯æŒ (3h)

- [x] å®ç° `src/services/formats/html/HtmlRenderer.ts`
- [x] æ›´æ–° `src/services/formats/index.ts` æ˜ å°„ `html`
- [x] æ›´æ–° `src/constants/fileTypes.ts` æ”¯æŒ `.html`
- [x] æµ‹è¯• HTML é˜…è¯»ï¼ˆå¤„ç†å†…è”æ ·å¼ä¸èµ„æºå¼•ç”¨ï¼‰

### 6.3 æ‰§è¡Œé¡ºåº

```
Phase 0 â†’ Phase 1 â†’ Phase 2 â†’ Phase 3 â†’ Phase 4 â†’ Phase 5 â†’ Phase 6
  â†“
å¿…é¡»å…ˆå®Œæˆæ¥å£å®šä¹‰
  â†“
é‡æ„ PDF ç¡®ä¿æ¥å£è®¾è®¡åˆç†
  â†“
Markdown å®ç°ç®€å•ï¼Œç”¨äºéªŒè¯æ¶æ„ï¼ˆçº¯å‰ç«¯æ¸²æŸ“ï¼‰
  â†“
EPUB æ˜¯æœ€å¸¸ç”¨çš„ç”µå­ä¹¦æ ¼å¼
  â†“
MOBI/AZW3/FB2 ä½¿ç”¨ç»Ÿä¸€æ–¹æ¡ˆ
  â†“
HTML ä½œä¸ºåŸºç¡€æ ¼å¼æœ€åå®ç°
  â†“
æ•´ä½“æµ‹è¯•ä¸ä¼˜åŒ–
```

---

## 7. æŠ€æœ¯ç»†èŠ‚

### 7.1 å‰ç«¯æ¸²æŸ“å™¨å·¥å‚

```typescript
// src/services/formats/index.ts
import { IBookRenderer, BookFormat } from './types';
import { PdfRenderer } from './pdf/PdfRenderer';
import { EpubRenderer } from './epub/EpubRenderer';
import { MarkdownRenderer } from './markdown/MarkdownRenderer';
import { FoliateRenderer } from './foliate/FoliateRenderer';
import { HtmlRenderer } from './html/HtmlRenderer';

export function createRenderer(filePath: string): IBookRenderer {
  const ext = filePath.toLowerCase().split('.').pop();
  
  switch (ext) {
    case 'pdf':
      return new PdfRenderer();
    case 'md':
    case 'markdown':
      return new MarkdownRenderer();
    case 'html':
      return new HtmlRenderer();
    case 'epub':
      return new EpubRenderer();
    case 'mobi':
      return new FoliateRenderer('mobi');
    case 'azw3':
    case 'azw':
      return new FoliateRenderer('azw3');
    case 'fb2':
      return new FoliateRenderer('fb2');
    default:
      throw new Error(`Unsupported format: ${ext}`);
  }
}

export * from './types';
```

### 7.2 Reader.tsx é‡æ„ç¤ºä¾‹

```typescript
// Reader.tsx æ ¸å¿ƒä¿®æ”¹
import { createRenderer, IBookRenderer } from '../services/formats';

export const Reader: React.FC = () => {
  const [renderer, setRenderer] = useState<IBookRenderer | null>(null);
  
  // åˆå§‹åŒ–æ¸²æŸ“å™¨
  useEffect(() => {
    const initRenderer = async () => {
      if (!book) return;
      
      const r = createRenderer(book.file_path);
      const info = await r.loadDocument(book.file_path);
      
      setRenderer(r);
      setTotalPages(info.pageCount);
    };
    
    initRenderer();
    
    return () => {
      renderer?.close();
    };
  }, [book]);
  
  // æ¸²æŸ“é¡µé¢
  const renderPage = async (pageNum: number) => {
    if (!renderer || !containerRef.current) return;
    await renderer.renderPage(pageNum, containerRef.current, {
      quality: settings.renderQuality,
    });
  };
  
  // ... å…¶ä½™ UI é€»è¾‘ä¿æŒä¸å˜
};
```

### 7.3 æ›´æ–°æ–‡ä»¶ç±»å‹é…ç½®

```typescript
// src/constants/fileTypes.ts
export const SUPPORTED_FILE_EXTENSIONS = [
  '.pdf',
  '.epub',
  '.md',
  '.markdown',
  '.mobi',
  '.azw3',
  '.azw',
  '.fb2',
  '.html'
] as const;

export type SupportedExtension = typeof SUPPORTED_FILE_EXTENSIONS[number];

export function getBookFormat(filePath: string): BookFormat | null {
  const ext = filePath.toLowerCase().split('.').pop() as string;
  const formatMap: Record<string, BookFormat> = {
    pdf: 'pdf',
    epub: 'epub',
    md: 'markdown',
    markdown: 'markdown',
    mobi: 'mobi',
    azw3: 'azw3',
    azw: 'azw3',
    fb2: 'fb2',
    html: 'html'
  };
  return formatMap[ext] || null;
}
```

### 7.4 åç«¯ Cargo.toml ä¾èµ–

```toml
# æ–°å¢ä¾èµ–
chardetng = "0.1"          # ç¼–ç æ£€æµ‹
encoding_rs = "0.8"        # ç¼–ç è½¬æ¢
epub = "2.1"               # EPUB è§£æï¼ˆå¯é€‰ï¼‰
quick-xml = "0.36"         # FB2 XML è§£æï¼ˆå¯é€‰ï¼‰
mobi = "0.4"               # MOBI è§£æï¼ˆå¯é€‰ï¼‰
```

---

## 8. é£é™©ä¸æ³¨æ„äº‹é¡¹

### 8.1 å…¼å®¹æ€§

- EPUB 3.x æŸäº›ç‰¹æ€§ï¼ˆå¦‚ Media Overlaysï¼‰å¯èƒ½ä¸è¢« `epub.js` å®Œå…¨æ”¯æŒ
- MOBI/AZW3 çš„ DRM ä¿æŠ¤æ–‡ä»¶æ— æ³•æ‰“å¼€

### 8.2 æ€§èƒ½

- EPUB/MOBI ç­‰æ ¼å¼åœ¨é¦–æ¬¡æ‰“å¼€æ—¶éœ€è¦è§£å‹å’Œè§£æï¼Œå¯èƒ½è¾ƒæ…¢
- å»ºè®®æ˜¾ç¤ºåŠ è½½è¿›åº¦

### 8.3 ç§»åŠ¨ç«¯é€‚é…

- `foliate-js` åœ¨ç§»åŠ¨ç«¯ WebView ä¸­çš„å…¼å®¹æ€§éœ€è¦æµ‹è¯•
- EPUB æ¸²æŸ“å¯èƒ½æ¶ˆè€—è¾ƒå¤šå†…å­˜

---

## 9. æ€»ç»“

æœ¬æ–¹æ¡ˆé€šè¿‡å®šä¹‰ç»Ÿä¸€çš„ `IBookRenderer` æ¥å£ï¼Œä½¿ `Reader.tsx` ä¸å…·ä½“æ ¼å¼è§£è€¦ã€‚æ ¸å¿ƒæ€è·¯ï¼š

1. **å‰ç«¯æ¥å£æŠ½è±¡**: æ‰€æœ‰æ ¼å¼å®ç°ç»Ÿä¸€çš„ `IBookRenderer` æ¥å£
2. **åç«¯èŒè´£æ˜ç¡®**: è´Ÿè´£æ–‡ä»¶è¯»å–ã€å…ƒæ•°æ®æå–ã€ç¼–ç å¤„ç†
3. **æ¸è¿›å¼é‡æ„**: å…ˆè¿ç§» PDFï¼ŒéªŒè¯æ¶æ„åå†æ·»åŠ æ–°æ ¼å¼
4. **å¤ç”¨ç°æœ‰é€»è¾‘**: UI çŠ¶æ€ã€ç¿»é¡µã€ä¹¦ç­¾ç­‰é€»è¾‘å®Œå…¨å¤ç”¨

æ‰§è¡Œé¡ºåºï¼š**æ¥å£å®šä¹‰ â†’ PDF é‡æ„ â†’ Markdown â†’ EPUB â†’ MOBI/AZW3/FB2 â†’ HTML**
